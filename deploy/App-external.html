<!DOCTYPE html>
<html>
<head>
    <title>FeatureTestTraceability</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var packageType="iOS",app=null,storyCache=[],storyFeatureMap=[],featureCache=[];Ext.define("TestCaseTraceability",{extend:"Rally.app.App",componentCls:"app",launch:function(){app=this;var tcStore=Ext.create("Rally.data.wsapi.Store",{model:"TestCase",fetch:["Name","WorkProduct.Parent","Tags.Name","WorkProduct","LastVerdict","Results","FormattedID"],filters:[{property:"Tags.Name",operator:"=",value:"SRS TC"}],autoLoad:!1,limit:"Infinity"});tcStore.load().then({success:app.loadTestCases}).then({success:function(traceRecords){console.log("============================================================"),console.log("==traceRecords: ",traceRecords),app.processTraceRecords(traceRecords),console.log("============================================================")},failure:function(error){console.log("==error: ",error)}})},loadTestCases:function(testCases){var deferred=Ext.create("Deft.Deferred"),promises=[];return _.each(testCases,function(testCase){if(testCase.data.WorkProduct&&"HierarchicalRequirement"==testCase.data.WorkProduct._type){var traceRecord={testCaseId:testCase.data.FormattedID,testCaseName:testCase.data.Name,lastVerdict:null,featureName:null,featureID:null},deferred=Ext.create("Deft.Deferred");app.loadFeatureForTestCase(testCase).then({success:function(feature){traceRecord.featureID=feature.get("FormattedID"),traceRecord.featureName=feature.get("Name"),app.loadResultForTestCase(testCase).then({success:function(lastVerdict){traceRecord.lastVerdict=lastVerdict,console.log("==traceRecord: ",traceRecord),deferred.resolve(traceRecord)}})}}),promises.push(deferred.promise)}}),Deft.Promise.all(promises)},loadFeatureForTestCase:function(testCase){var deferred=Ext.create("Deft.Deferred"),storyID=testCase.data.WorkProduct.FormattedID;if(_.contains(storyCache,storyID)){var feature=featureCache[storyFeatureMap[storyID]];if(feature)return deferred.resolve(),deferred.promise}console.log("USer Story: ",storyID);var storyStore=Ext.create("Rally.data.wsapi.Store",{model:"UserStory",fetch:["Feature","Feature.FormattedID","Feature[FormattedID]"],filters:[{property:"FormattedID",operator:"=",value:testCase.data.WorkProduct.FormattedID}],autoLoad:!1});return storyStore.load({callback:function(stories,operation,success){if(success){var feature=stories[0].data.Feature;if(feature){var featureOID=feature._ref.split("/")[3];console.log("Feature oid: ",featureOID),storyFeatureMap.push({storyID:featureOID}),app.getFeatureDetails(featureOID).then({success:function(feature){console.log("feature: ",feature),deferred.resolve(feature)}})}else traceRecord.feature="No Feature Found",deferred.reject("Could not find feature")}else console.log("Error loading stories."),deferred.reject("Error loading stories.")}}),storyCache.push(storyID),deferred.promise},getFeatureDetails:function(featureOID){var deferred=Ext.create("Deft.Deferred");if(_.contains(_.keys(featureCache),featureOID))return deferred.resolve(featureCache[featureOID]);var featureStore=Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Feature",fetch:["FormattedID","Name"],filters:[{property:"ObjectID",operator:"=",value:featureOID}],autoLoad:!0});return featureStore.load({callback:function(features,operation,success){success?features[0]&&(featureCache.push({featureOID:features[0]}),deferred.resolve(features[0])):(deferred.reject("Error loading feature"),console.log("Couldn't load feature"))}}),deferred.promise},loadResultForTestCase:function(testCase){var deferred=Ext.create("Deft.Deferred");return testCase.getCollection("Results").load({callback:function(results,operation,success){var result="--";if(success){for(var index=results.length;index--;index>=0)if(results[index].data.SystemPackage=packageType){result=results[index].data.Verdict;break}console.log("result: ",result),deferred.resolve(result)}else deferred.reject("Error loading results.")}}),deferred.promise},processTraceRecords:function(traceRecords){var grid=app.down("rallygrid");grid&&grid.destroy(),console.log("traceRecords: ",traceRecords),app.add({xtype:"rallygrid",showPagingToolbar:!0,showRowActionsColumn:!1,editable:!1,context:app.getContext(),features:[{ftype:"groupingsummary",groupHeaderTpl:"{name} ({rows.length})"}],store:Ext.create("Rally.data.custom.Store",{data:traceRecords,groupField:"featureID",groupDir:"ASC",getGroupString:function(record){var groupString=record.get("featureID");return groupString=groupString?groupString+" "+record.get("featureName"):"No feature found"}}),columnCfgs:[{text:"TestCase ID",dataIndex:"testCaseId",flex:1},{text:"TestCase Name",dataIndex:"testCaseName",flex:1},{text:"Result",dataIndex:"lastVerdict",flex:1}],context:app.getContext()})}});

            Rally.launchApp('TestCaseTraceability', {
                name:"FeatureTestTraceability",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
